<!doctype html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-9B36Y7KESM"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9B36Y7KESM'); </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Nassalab Store ‚Äî Premium Injectables, Orals, PCT & More</title>
  <meta name="description"
        content="Browse Nassalab‚Äôs full product line ‚Äî injectable steroids, oral steroids, SARMs, peptides and PCT. High purity, fast delivery, verified quality.">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0A66CC;
      --accent:#0b8bd6;
      --bg:#f6fbff;
      --card:#fff;
      --muted:#6b7280;
      --text:#0b1220;
      --container:1180px;
      --radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:"Inter", sans-serif;
    }
    a{text-decoration:none;color:inherit;}

    .container{
      max-width:var(--container);
      margin:0 auto;
      padding:28px;
    }

    /* HEADER */
    header{
      position:sticky;
      top:0;
      background:#fff;
      border-bottom:1px solid rgba(0,0,0,.05);
      z-index:999;
      padding:10px 0;
    }
    .nav-inner{
      max-width:var(--container);
      margin:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 20px;
      gap:12px;
    }
    .logo{
      width:48px;height:48px;border-radius:10px;
      background:var(--primary);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#fff;font-size:20px;
    }
    nav.main a{
      padding:8px 12px;
      font-weight:600;
      color:var(--muted);
    }

    /* HERO */
    /* Put position:relative so pseudo overlay is confined and won't leak above other sections */
    .store-hero{
      position:relative;
      background: url('bk1.jpg') no-repeat center center;
      background-size: cover;
      border-radius:14px;
      padding:26px;
      margin-bottom:18px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 8px 28px rgba(3,12,30,0.04);
      overflow:visible;
    }
    .store-hero::before {
      content:"";
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.25); /* darker if needed */
      border-radius:14px;
      z-index:0;
      pointer-events:none;
    }
    .store-hero > * { position:relative; z-index:1; }

    .store-hero h1{
      font-size:26px;
      font-weight:800;
      color:#fff;
      margin:0;
    }
    .store-hero p{ color:rgba(255,255,255,0.92); margin-top:6px; max-width:540px; }

    .search{
      display:flex;
      background:rgba(255,255,255,0.96);
      border-radius:12px;
      padding:8px 12px;
      border:1px solid rgba(0,0,0,.06);
      gap:8px;
      align-items:center;
    }
    .search input{
      border:0;background:transparent;
      font-size:15px;
      min-width:180px;
      width:260px;
    }

    .filter-btn{
      background:var(--primary);
      color:#fff;
      border:0;
      padding:10px 16px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }

    select{
      padding:10px 12px;
      background:#fff;
      border-radius:10px;
      border:1px solid #dce9f9;
    }

    /* GRID */
    .product-grid{
      display:grid;
      gap:20px;
      margin-top:25px;
    }
    @media(min-width:1200px){ .product-grid{grid-template-columns:repeat(4,1fr);} }
    @media(min-width:900px) and (max-width:1199px){ .product-grid{grid-template-columns:repeat(3,1fr);} }
    @media(min-width:600px) and (max-width:899px){ .product-grid{grid-template-columns:repeat(2,1fr);} }
    @media(max-width:599px){ .product-grid{grid-template-columns:repeat(1,1fr);} }

    /* PRODUCT CARD */
    .card{
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 6px 22px rgba(0,0,0,0.06);
      transition:.18s;
      display:flex;flex-direction:column;
      min-height:320px;
      position:relative;
    }
    .card:hover{ transform:translateY(-6px); }

    .visual{
      height:220px;
      background:#eef5ff;
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;
    }
    .visual img{
      width:100%;height:100%;object-fit:cover;display:block;
    }

    .card-footer{
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-top:auto;
    }
    /* allow product name to wrap and show full title */
    .card-title{
      font-weight:700;
      font-size:14px;
      line-height:1.25;
      display:block;
      word-break:break-word;
      max-width:60%;
      white-space:normal;
    }
    .card-right{ display:flex; gap:8px; align-items:center; }

    .price{
      font-weight:800;
      color:var(--primary);
      white-space:nowrap;
    }

    .btn-add{
      background:var(--primary);
      color:#fff;
      border:0;
      padding:8px 12px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }

    /* PAGINATION */
    .pager{
      margin-top:20px;
      display:flex;
      justify-content:center;
      gap:12px;
    }
    .pager button{
      padding:10px 16px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.1);
      background:#fff;
      cursor:pointer;
    }

    /* REVIEWS */
    .reviews{
      margin-top:40px;
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.05);
    }
    .review{
      padding:12px 0;
      border-bottom:1px dashed #e6efff;
    }
    .review:last-child{border-bottom:0;}

    /* FOOTER */
    footer{
      margin-top:40px;
      background:#0A66CC;
      color:#fff;
      padding:30px 0;
    }
    footer .footer-row{
      max-width:var(--container);
      margin:auto;
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      justify-content:space-between;
    }
    footer a{color:#fff;font-weight:600;}

    /* small screens */
    @media (max-width:640px){
      .store-hero{ padding:18px; }
      .search input{ width:160px; }
      .card{ min-height:260px; }
      .card-footer{ flex-direction:column; align-items:flex-start; gap:6px; }
      .card-right{ width:100%; display:flex; justify-content:space-between; }
    }
  </style>
</head>

<body>

<header>
  <div class="nav-inner">
    <div style="display:flex;align-items:center;gap:14px">
      <div class="logo">NL</div>
      <div>
        <div style="font-weight:700;font-size:18px">Nassalab</div>
        <div style="color:var(--muted);font-size:12px">Premium Anabolics</div>
      </div>
    </div>

    <nav class="main" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="store.html" style="color:var(--primary);font-weight:700">Store</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div>
      <button style="background:#fff;border:1px solid #dce9f9;padding:8px 10px;border-radius:8px" onclick="location.href='cart.html'" aria-label="View cart">
        üõí <span id="cartCount">0</span>
      </button>
    </div>
  </div>
</header>

<main class="container">

  <section class="store-hero" aria-label="Store hero">
    <div>
<p>
        .
      </p>
      <h1>Shop Nassalab ‚Äî High Purity Injectables, Orals & PCT</h1>
      <p>
        .
<p>
        .
      </p>
      </p>
    </div>

    <div style="display:flex;gap:14px;align-items:center">
      <div class="search" role="search" aria-label="Search products">
        <input id="storeSearch" placeholder="Search by name, mg or category‚Ä¶" aria-label="Search the store">
        <button id="searchBtn" title="Search" style="background:transparent;border:0;font-weight:700;color:var(--primary);cursor:pointer">Go</button>
      </div>
      <button id="clearFilters" class="filter-btn">Clear</button>
    </div>
  </section>

  <div style="margin-top:18px;display:flex;gap:14px;flex-wrap:wrap;align-items:center">
    <select id="catFilter" aria-label="Filter by category"></select>
    <select id="sortSelect" aria-label="Sort products">
      <option value="featured">Featured</option>
      <option value="price-asc">Price ‚Äî Low to high</option>
      <option value="price-desc">Price ‚Äî High to low</option>
      <option value="name-asc">Name A ‚Üí Z</option>
    </select>
    <div id="resultCount" style="color:var(--muted);padding-top:10px">Loading‚Ä¶</div>
  </div>

  <div id="productGrid" class="product-grid" aria-live="polite" style="margin-bottom:18px"></div>

  <div id="pager" class="pager" style="display:none">
    <button id="prevPage" aria-label="Previous page">‚Üê Prev</button>
    <div id="pageIndicator" style="padding-top:10px;font-weight:700;color:var(--muted)">Page 1</div>
    <button id="nextPage" aria-label="Next page">Next ‚Üí</button>
  </div>

  <div id="emptyState" style="display:none;margin-top:20px;text-align:center;color:var(--muted);">No products found.</div>

  <section class="reviews" aria-label="Customer reviews">
    <h3>Customer Reviews</h3>
    <div id="reviewsWrap" aria-live="polite"></div>
  </section>
</main>

<footer>
  <div class="footer-row">
    <div>
      <h3>Nassalab</h3>
      <p>Premium pharmaceutical-grade anabolics.</p>
    </div>
    <div>
      <a href="index.html">Home</a><br>
      <a href="store.html">Store</a><br>
      <a href="contact.html">Contact</a>
    </div>
    <div>
      <p>&copy; <span id="year"></span> Nassalab. All rights reserved.</p>
    </div>
  </div>
</footer>

<script>
/* STORE PAGE SCRIPT
   - robust image normalization
   - add-to-cart
   - prices shown as rounded whole numbers (no decimals)
   - placeholder fallback for missing images
*/

document.getElementById('year').textContent = new Date().getFullYear();

let PRODUCTS = [];
let currentPage = 1;
const PER_PAGE = 20;

// --- CART STATE MANAGEMENT (FIXED) ---
const CART_KEY = 'nassalab_cart_v1';
let CART_STATE = {
  items: {},
  isShippingRequired: false,
  promoCode: null,
};

function saveCartState() {
  localStorage.setItem(CART_KEY, JSON.stringify(CART_STATE));
  // Dispatch event so other tabs/headers update count
  window.dispatchEvent(new Event('storage')); 
}

// Safely load the cart, handling both the old and new storage formats
function loadCartState() {
  const rawState = localStorage.getItem(CART_KEY);
  if (!rawState) return;

  try {
    const loaded = JSON.parse(rawState);
    if (loaded && loaded.items && typeof loaded.items === 'object') {
      // New structured format
      CART_STATE = { 
        items: loaded.items,
        isShippingRequired: loaded.isShippingRequired || false,
        promoCode: loaded.promoCode || null
      };
    } else if (loaded && typeof loaded === 'object') {
      // Old simple format: convert it to the new internal structure
      CART_STATE.items = loaded;
      // Other properties remain default
    }
  } catch (e) {
    console.error("Error parsing cart state", e);
    // If parsing fails, reset to empty cart
    CART_STATE = { items: {}, isShippingRequired: false, promoCode: null };
  }
}

// --- Cart synchronization function (FIXED) ---
function syncCartFromStorage(){
  loadCartState(); // Load the state robustly

  // Calculate count from the CART_STATE.items object
  const count = Object.values(CART_STATE.items).reduce((s,n)=> s + (Number(n)||0), 0);
  
  if (count === 0 && (CART_STATE.isShippingRequired || CART_STATE.promoCode)) {
      // If the cart is empty but has old metadata, clean it up
      CART_STATE = { items: {}, isShippingRequired: false, promoCode: null };
      saveCartState();
  }
  
  document.getElementById('cartCount').textContent = count;
}


/* helpers */
function slugify(s){ return String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-').replace(/^-+|-+$/g,''); }

// parse price (string like "$65.00" or "65" -> return number)
function parsePriceValue(raw){
  if(typeof raw === 'number' && Number.isFinite(raw)) return Number(raw);
  if(!raw) return 0;
  const s = String(raw).trim();
  // remove currency symbols and commas
  const cleaned = s.replace(/[^0-9\.\-]/g,'').replace(/,+/g,'');
  const v = parseFloat(cleaned);
  return Number.isFinite(v) ? v : 0;
}
// format currency as whole number (no decimals)
function formatCurrencyWhole(n){
  const rounded = Math.round(Number(n||0));
  return '$' + rounded.toLocaleString();
}

// Normalize images: support {front, back}, array, or string
function normalizeImagesForProduct(p){
  if(!p) return ['placeholder.jpg'];
  if(!p.images) return ['placeholder.jpg'];
  if(Array.isArray(p.images)) return p.images.map(String).filter(Boolean);
  if(typeof p.images === 'object'){
    const arr = [];
    if(p.images.front) arr.push(String(p.images.front));
    if(p.images.back) arr.push(String(p.images.back));
    // numeric keys (0,1,2)
    Object.keys(p.images).sort().forEach(k=>{
      if(!isNaN(k)) arr.push(String(p.images[k]));
    });
    // if object had other string values (rare), add them
    Object.values(p.images).forEach(v=>{
      if(typeof v === 'string' && !arr.includes(v)) arr.push(v);
    });
    return arr.filter(Boolean).length ? arr.filter(Boolean) : ['placeholder.jpg'];
  }
  // string
  return [String(p.images)].filter(Boolean).length ? [String(p.images)] : ['placeholder.jpg'];
}

function getFirstImageForProduct(p){
  const imgs = normalizeImagesForProduct(p);
  return imgs && imgs.length ? imgs[0] : 'placeholder.jpg';
}

/* load products */
async function loadProducts(){
  try{
    const res = await fetch('products.json', {cache:'no-store'});
    if(!res.ok) throw new Error('Network error ' + res.status);
    let data;
    try { data = await res.json(); }
    catch(e){
      // fallback parse (strip trailing commas)
      const txt = await res.text();
      const cleaned = txt.replace(/^\uFEFF/, '').replace(/,\s*([\]}])/g, '$1').trim();
      data = JSON.parse(cleaned);
    }
    if(!Array.isArray(data) && data && data.products) data = data.products;
    PRODUCTS = (Array.isArray(data) ? data : []).map(p=>{
      // normalizations
      p._price = parsePriceValue(p.price ?? p._price ?? 0);
      p.images = normalizeImagesForProduct(p);
      if(!p.slug && p.name) p.slug = slugify(p.name);
      return p;
    });
    initFilters();
    applyUrlParams();
    renderProducts();
    renderReviews();
    syncCartFromStorage();
  }catch(err){
    console.error('Failed to load products.json', err);
    document.getElementById('productGrid').innerHTML = '<div style="padding:20px;background:#fff;border-radius:10px;color:#b00">Failed to load products. Check console.</div>';
  }
}

/* apply category/search from URL if present */
function applyUrlParams(){
  const params = new URLSearchParams(location.search);
  const cat = params.get('category') || '';
  const search = params.get('search') || '';
  const sort = params.get('sort') || '';
  if(cat) document.getElementById('catFilter').value = cat;
  if(search) document.getElementById('storeSearch').value = search;
  if(sort) document.getElementById('sortSelect').value = sort;
}

/* filters UI */
function initFilters(){
  const catSet = new Set(PRODUCTS.map(p => p.category || 'Other'));
  const cats = Array.from(catSet).sort();
  const catSel = document.getElementById('catFilter');
  catSel.innerHTML = `<option value="">All categories</option>`;
  cats.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    catSel.appendChild(opt);
  });
}

/* filtering + sorting */
function getFilterInputs(){
  return {
    q: (document.getElementById('storeSearch').value || '').trim().toLowerCase(),
    cat: (document.getElementById('catFilter').value || ''),
    sort: (document.getElementById('sortSelect').value || 'featured')
  };
}

function filteredList(){
  const { q, cat, sort } = getFilterInputs();
  let list = PRODUCTS.slice();
  if(q){
    list = list.filter(p => ((p.name||'') + ' ' + (p.short_description||'') + ' ' + (p.description||'') + ' ' + (p.category||'')).toLowerCase().includes(q));
  }
  if(cat){
    list = list.filter(p => p.category === cat);
  }
  if(sort === 'price-asc') list.sort((a,b)=>a._price - b._price);
  else if(sort === 'price-desc') list.sort((a,b)=>b._price - a._price);
  else if(sort === 'name-asc') list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  // else featured: keep original order
  return list;
}

/* rendering */
function renderProducts(){
  const list = filteredList();
  document.getElementById('resultCount').textContent = `${list.length} results`;
  if(!list.length){
    document.getElementById('productGrid').innerHTML = '';
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('pager').style.display = 'none';
    return;
  } else {
    document.getElementById('emptyState').style.display = 'none';
  }

  const totalPages = Math.max(1, Math.ceil(list.length / PER_PAGE));
  if(currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * PER_PAGE;
  const pageItems = list.slice(start, start + PER_PAGE);

  const grid = document.getElementById('productGrid');
  grid.innerHTML = '';

  pageItems.forEach(p=>{
    const img = getFirstImageForProduct(p) || 'placeholder.jpg';
    // build card element (DOM, to avoid innerHTML XSS issues)
    const card = document.createElement('article');
    card.className = 'card';
    card.tabIndex = 0;
    card.setAttribute('role','link');
    card.style.cursor = 'pointer';

    // click to product page
    card.addEventListener('click', ()=> { location.href = `product.html?slug=${encodeURIComponent(p.slug)}`; });
    card.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') location.href = `product.html?slug=${encodeURIComponent(p.slug)}`; });

    const vis = document.createElement('div'); vis.className = 'visual';
    const im = document.createElement('img'); im.loading='lazy'; im.src = img; im.alt = p.name || 'Product image';
    vis.appendChild(im);

    const footer = document.createElement('div'); footer.className = 'card-footer';
    const title = document.createElement('div'); title.className = 'card-title'; title.textContent = p.name || '';
    const right = document.createElement('div'); right.className = 'card-right';
    const price = document.createElement('div'); price.className = 'price'; price.textContent = formatCurrencyWhole(p._price);
    const btn = document.createElement('button'); btn.className = 'btn-add'; btn.textContent = 'Add';
    // prevent card click when pressing Add
    btn.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      addToCart(p);
      btn.textContent = 'Added';
      setTimeout(()=> btn.textContent = 'Add', 800);
    });

    right.appendChild(price);
    right.appendChild(btn);

    footer.appendChild(title);
    footer.appendChild(right);

    card.appendChild(vis);
    card.appendChild(footer);
    grid.appendChild(card);
  });

  renderPager(list.length, totalPages);
}

/* pager */
function renderPager(total, totalPages){
  const pager = document.getElementById('pager');
  if(totalPages <= 1){
    pager.style.display = 'none';
  } else {
    pager.style.display = 'flex';
  }
  document.getElementById('pageIndicator').textContent = `Page ${currentPage} / ${totalPages}`;
  document.getElementById('prevPage').onclick = ()=> { if(currentPage>1){ currentPage--; renderProducts(); window.scrollTo({top:140, behavior:'smooth'}); } };
  document.getElementById('nextPage').onclick = ()=> { if(currentPage<totalPages){ currentPage++; renderProducts(); window.scrollTo({top:140, behavior:'smooth'}); } };
}

/* add to cart (FIXED to use CART_STATE structure) */
function addToCart(product){
  loadCartState(); // Load current state
  const id = String(product.id || product.slug || product.sku || product.slug);
  
  // Add item to the items property of the structured state
  CART_STATE.items[id] = (CART_STATE.items[id]||0) + 1; 
  
  saveCartState(); // Save the complete structured state
  syncCartFromStorage();
}


/* init listeners */
document.getElementById('catFilter').addEventListener('change', ()=>{ currentPage = 1; renderProducts(); });
document.getElementById('storeSearch').addEventListener('input', ()=>{ currentPage = 1; renderProducts(); });
document.getElementById('sortSelect').addEventListener('change', ()=>{ currentPage = 1; renderProducts(); });
document.getElementById('clearFilters').addEventListener('click', ()=>{
  document.getElementById('storeSearch').value = '';
  document.getElementById('catFilter').value = '';
  document.getElementById('sortSelect').value = 'featured';
  currentPage = 1;
  renderProducts();
});
document.getElementById('searchBtn').addEventListener('click', ()=>{ currentPage=1; renderProducts(); });

/* preserve cart across tabs */
window.addEventListener('storage', (e)=>{ if(e.key === CART_KEY) syncCartFromStorage(); });

/* Reviews (demo) */
function renderReviews(){
  const wrap = document.getElementById('reviewsWrap');
  const fakeReviews = [
    { name:"Michael A.", text:"Fast delivery and the quality is unmatched. Will order again.", stars:5 },
    { name:"Daniel K.", text:"Product packaging was discreet and professional. Works exactly as described.", stars:5 },
    { name:"Rico P.", text:"Best source online. Legit, clean and potent.", stars:5 },
  ];
  wrap.innerHTML = fakeReviews.map(r => `
    <div class="review">
      <strong>${escapeHtml(r.name)}</strong> ‚Äî ${'‚≠ê'.repeat(r.stars)}<br>
      <p style="margin:6px 0 0 0">${escapeHtml(r.text)}</p>
    </div>
  `).join('');
}

/* small helper to escape text used in reviews */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Kickoff */
loadProducts();
syncCartFromStorage();
</script>

</body>
</html>
