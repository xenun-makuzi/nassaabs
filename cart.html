<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart ‚Äî Nassalab</title>
  <meta name="description" content="View your shopping cart ‚Äî Nassalab">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0A66CC;
      --bg: #f6fbff;
      --card: #fff;
      --muted: #6b7280;
      --text: #0b1220;
      --container: 1180px;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Inter", system-ui, sans-serif; background: var(--bg); color: var(--text); }
    a { color: inherit; text-decoration: none; }
    
    .container { max-width: var(--container); margin: 0 auto; padding: 28px; }

    /* Header */
    header { position: sticky; top: 0; background: rgba(255,255,255,0.96); backdrop-filter: blur(4px); border-bottom: 1px solid rgba(7,22,42,0.04); z-index: 999; }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; gap: 12px; max-width: var(--container); margin: 0 auto; padding: 14px 18px; }
    .logo { width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(180deg, var(--primary), #075bb3); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 18px; }
    nav.main { display: flex; gap: 14px; align-items: center; }
    nav.main a { padding: 8px 12px; border-radius: 10px; color: var(--muted); font-weight: 600; }
    
    /* Cart Layout */
    .cart-layout { display: grid; grid-template-columns: 1fr 340px; gap: 24px; margin-top: 20px; }
    
    /* Cart Items Column */
    .cart-items { background: var(--card); border-radius: 14px; box-shadow: 0 10px 30px rgba(5,12,30,0.06); overflow: hidden; }
    .cart-header { padding: 18px; border-bottom: 1px solid #f0f4f8; font-weight: 700; font-size: 18px; }
    
    .cart-row { display: flex; align-items: center; padding: 18px; border-bottom: 1px solid #f0f4f8; gap: 16px; }
    .cart-row:last-child { border-bottom: 0; }
    
    .item-img { width: 80px; height: 80px; background: #f2f6fb; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
    
    .item-details { flex: 1; }
    .item-name { font-weight: 700; font-size: 15px; margin-bottom: 4px; line-height: 1.3; }
    .item-meta { color: var(--muted); font-size: 13px; }
    
    .item-qty { display: flex; align-items: center; background: #f0f4f8; border-radius: 8px; padding: 4px; }
    .qty-btn { width: 28px; height: 28px; border: 0; background: #fff; border-radius: 6px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .qty-val { width: 32px; text-align: center; font-size: 14px; font-weight: 600; }
    
    .item-price { font-weight: 700; font-size: 16px; min-width: 80px; text-align: right; }
    .item-remove { color: #dc2626; font-size: 12px; margin-top: 6px; cursor: pointer; text-decoration: underline; background: 0; border: 0; padding: 0; }

    /* Summary Column */
    .summary-card { background: var(--card); border-radius: 14px; padding: 24px; box-shadow: 0 10px 30px rgba(5,12,30,0.06); position: sticky; top: 100px; }
    .summary-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
    .summary-row.total { border-top: 1px dashed #e5e7eb; padding-top: 16px; margin-top: 16px; font-weight: 800; font-size: 18px; color: var(--primary); }
    
    .shipping-toggle { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; }
    .shipping-toggle label { font-weight: 600; font-size: 14px; }
    
    /* Promo Input */
    .promo-input-group { display: flex; margin-bottom: 16px; }
    .promo-input-group input { flex: 1; padding: 10px 12px; border: 1px solid #e2e8f0; border-right: 0; border-radius: 8px 0 0 8px; font-size: 14px; }
    .promo-input-group button { background: var(--primary); color: #fff; padding: 10px 14px; border: 0; border-radius: 0 8px 8px 0; font-weight: 600; cursor: pointer; transition: background .2s; }
    .promo-input-group button:hover { background: #0855aa; }
    .promo-message { font-size: 12px; color: #16a34a; margin-top: -8px; margin-bottom: 12px; }
    .promo-message.error { color: #dc2626; }


    .btn-checkout { display: block; width: 100%; background: var(--primary); color: #fff; text-align: center; padding: 14px; border-radius: 10px; font-weight: 700; margin-top: 20px; border: 0; cursor: pointer; transition: background .2s; }
    .btn-checkout:hover { background: #0855aa; }
    
    .empty-state { padding: 60px 20px; text-align: center; }
    .empty-icon { font-size: 48px; margin-bottom: 16px; display: block; }
    .btn-shop { display: inline-block; margin-top: 16px; background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 10px; font-weight: 700; }

    /* Footer */
    footer { margin-top: 40px; background: #eaf6ff; padding: 22px; border-top: 1px solid rgba(7,22,42,0.04); }
    .footer-inner { max-width: var(--container); margin: 0 auto; text-align: center; color: #05324a; }

    @media(max-width: 800px) {
      .cart-layout { grid-template-columns: 1fr; }
      .cart-row { align-items: flex-start; }
      .item-price { text-align: left; margin-top: 8px; }
    }
  </style>
</head>
<body>

<header>
  <div class="nav-inner">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo">NL</div>
      <div>
        <div style="font-weight:700">Nassalab</div>
        <div style="font-size:12px;color:var(--muted)">Shopping Cart</div>
      </div>
    </div>
    <nav class="main">
      <a href="index.html">Home</a>
      <a href="store.html">Store</a>
    </nav>
  </div>
</header>

<div class="container">
  <h1>Your Cart</h1>

  <div id="loading" style="padding:40px;text-align:center;color:var(--muted)">Loading cart...</div>

  <div id="cartContent" class="cart-layout" style="display:none">
    
    <div class="cart-items">
      <div class="cart-header">Items (<span id="itemCountDisplay">0</span>)</div>
      <div id="cartList">
        </div>
    </div>

    <div class="summary">
      <div class="summary-card">
        <div class="summary-title">Order Summary</div>

        <div class="shipping-toggle">
          <label for="shippingToggle">Shipping Required?</label>
          <input type="checkbox" id="shippingToggle" onchange="toggleShipping(this.checked)">
        </div>

        <div class="promo-input-group">
          <input type="text" id="promoInput" placeholder="Promo Code">
          <button onclick="applyPromoCode()">Apply</button>
        </div>
        <div id="promoMessage" class="promo-message" style="display:none;"></div>
        
        <div class="summary-row">
          <span class="muted">Subtotal</span>
          <span id="subTotal">$0.00</span>
        </div>
        
        <div class="summary-row" id="discountRow" style="display:none;">
          <span class="muted" style="color:#16a34a;">Discount (<span id="discountPercent">0%</span>)</span>
          <span id="discountValue" style="color:#16a34a;">-$0.00</span>
        </div>

        <div class="summary-row" id="shippingRow">
          <span class="muted">Shipping</span>
          <span id="shippingCost">Free</span>
        </div>
        
        <div class="summary-row">
          <span class="muted">Tax</span>
          <span>$0.00</span>
        </div>
        
        <div class="summary-row total">
          <span>Total</span>
          <span id="finalTotal">$0.00</span>
        </div>

        <button class="btn-checkout" onclick="window.location.href='checkout.html'">Proceed to Checkout</button>
        
        <div style="margin-top:16px;font-size:12px;color:var(--muted);text-align:center;line-height:1.4">
          Secure checkout. We accept Bitcoin, USDT, and Bank Transfer.
        </div>
      </div>
    </div>
  </div>

  <div id="emptyCart" class="empty-state" style="display:none">
    <span class="empty-icon">üõí</span>
    <h2>Your cart is empty</h2>
    <p class="muted">Looks like you haven't added any products yet.</p>
    <a href="store.html" class="btn-shop">Browse Store</a>
  </div>
</div>

<footer>
  <div class="footer-inner">
    ¬© <span id="year"></span> Nassalab ‚Äî All rights reserved
  </div>
</footer>

<script>
/* ------------------------------------------------
   Cart Logic (Updated for EmailJS)
   ------------------------------------------------ */

// --- EmailJS Setup (NEW) ---
/* IMPORTANT: Replace "YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", and "YOUR_PUBLIC_KEY" with your actual EmailJS credentials. */
const EMAILJS_SERVICE_ID = "Payment911"; // Placeholder from cart2.html
const EMAILJS_TEMPLATE_ID = "template_b7erllf"; // Placeholder from cart2.html
const EMAILJS_PUBLIC_KEY = "NHFB-BLLpTMnFelp_"; // Placeholder from cart2.html

// Load the EmailJS library
const script = document.createElement('script');
script.type = 'text/javascript';
script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
document.head.appendChild(script);

// Initialize EmailJS when the script loads
script.onload = function() {
  if (typeof emailjs !== 'undefined') {
    emailjs.init(EMAILJS_PUBLIC_KEY);
  } else {
    console.error("EmailJS failed to load.");
  }
};
// --- End EmailJS Setup ---


let PRODUCTS = [];
let CART_STATE = {
  items: {},
  isShippingRequired: false,
  promoCode: null,
};
const CART_KEY = 'nassalab_cart_v1';
const SHIPPING_FEE = 60; // $60 shipping fee

// Define Promo Codes: CALI20 (10%), NEWGUY (5%), BOOST (8%), BOGO (15%)
const PROMO_CODES = {
  CALI20: 0.10, 
  NEWGUY: 0.05,
  BOOST: 0.08,
  BOGO: 0.15,
};

document.getElementById('year').textContent = new Date().getFullYear();

// --- Helper Functions ---
function parsePrice(raw) {
  if (typeof raw === 'number') return raw;
  if (!raw) return 0;
  return parseFloat(String(raw).replace(/[^0-9.]/g, '')) || 0;
}

function formatPrice(num) {
  // Use Math.round for currency precision
  return '$' + Math.round(num).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
// Helper function to get the raw number from a formatted price string
function getRawPrice(formattedPrice) {
    if (!formattedPrice) return 0;
    return parsePrice(formattedPrice.replace('$', '').replace(/,/g, ''));
}


function normalizeImage(p) {
  if (!p.images) return 'placeholder.jpg';
  if (Array.isArray(p.images)) return p.images[0] || 'placeholder.jpg';
  if (typeof p.images === 'object') return p.images.front || Object.values(p.images)[0] || 'placeholder.jpg';
  return String(p.images);
}

function getDiscountPercentage(code) {
    if (!code) return 0;
    const upperCode = code.toUpperCase();
    return PROMO_CODES[upperCode] || 0;
}

function saveCartState() {
  localStorage.setItem(CART_KEY, JSON.stringify(CART_STATE));
  // Dispatch event so other tabs/headers update count
  window.dispatchEvent(new Event('storage')); 
}

// --- Main Cart Functions ---

// 1. Load Products & Cart State
async function init() {
  try {
    // Load local cart state
    const rawState = localStorage.getItem(CART_KEY);
    const loadedState = rawState ? JSON.parse(rawState) : {};

    // Check for old cart format (just item:qty map)
    if (!loadedState.items && rawState && rawState.startsWith('{') && !rawState.includes('isShippingRequired')) {
      CART_STATE.items = loadedState; // Old format
    } else {
      CART_STATE = { ...CART_STATE, ...loadedState };
    }

    // Load DB
    const res = await fetch('products.json');
    let data = await res.json();
    if(data.products) data = data.products; // handle if wrapped
    PRODUCTS = Array.isArray(data) ? data : [];

    // Sync state to UI elements
    document.getElementById('shippingToggle').checked = CART_STATE.isShippingRequired;
    if (CART_STATE.promoCode) {
      document.getElementById('promoInput').value = CART_STATE.promoCode;
    }
    
    // NOTE (NEW): Replace the inline onclick on the checkout button with this new handler
    document.querySelector('.btn-checkout').onclick = handleCheckout; 

    render();
    document.getElementById('loading').style.display = 'none';
  } catch (err) {
    console.error(err);
    document.getElementById('loading').innerHTML = 'Error loading cart data.';
  }
}

// 2. Render Cart & Calculate Totals
function render() {
  const container = document.getElementById('cartContent');
  const emptyState = document.getElementById('emptyCart');
  const listEl = document.getElementById('cartList');

  const ids = Object.keys(CART_STATE.items);

  // Check if empty
  if (ids.length === 0) {
    container.style.display = 'none';
    emptyState.style.display = 'block';
    // Clear promo code and shipping state if cart is emptied
    CART_STATE.isShippingRequired = false;
    CART_STATE.promoCode = null;
    saveCartState();
    return;
  }

  container.style.display = 'grid';
  emptyState.style.display = 'none';
  listEl.innerHTML = '';
  
  // (NEW) Used to build the email content later
  window.ORDER_ITEMS_DETAIL = [];

  let subtotal = 0;
  let totalItems = 0;

  // Build rows and calculate subtotal
  ids.forEach(id => {
    const qty = CART_STATE.items[id];
    if (qty <= 0) return;

    const product = PRODUCTS.find(p => String(p.id) === id || p.slug === id);

    if (!product) {
      delete CART_STATE.items[id];
      saveCartState();
      return;
    }

    const price = parsePrice(product.price);
    const lineTotal = price * qty;
    subtotal += lineTotal;
    totalItems += qty;
    
    // (NEW) Store details for email
    window.ORDER_ITEMS_DETAIL.push({
        name: product.name,
        qty: qty,
        price: price,
        lineTotal: lineTotal
    });

    const row = document.createElement('div');
    row.className = 'cart-row';
    row.innerHTML = `
      <img src="${normalizeImage(product)}" class="item-img" alt="${product.name}">
      
      <div class="item-details">
        <div class="item-name"><a href="product.html?slug=${product.slug}">${product.name}</a></div>
        <div class="item-meta">${product.category || 'Product'}</div>
        <button class="item-remove" onclick="removeItem('${id}')">Remove</button>
      </div>

      <div class="item-qty">
        <button class="qty-btn" onclick="updateQty('${id}', -1)" aria-label="Decrease quantity">‚àí</button>
        <span class="qty-val">${qty}</span>
        <button class="qty-btn" onclick="updateQty('${id}', 1)" aria-label="Increase quantity">+</button>
      </div>

      <div class="item-price">
        <div>${formatPrice(lineTotal)}</div>
        <div style="font-size:12px;color:var(--muted);font-weight:400">${formatPrice(price)} ea</div>
      </div>
    `;
    listEl.appendChild(row);
  });

  // --- Summary Calculations ---

  // 1. Discount
  const discountRate = getDiscountPercentage(CART_STATE.promoCode);
  const discountValue = subtotal * discountRate;
  const subtotalAfterDiscount = subtotal - discountValue;

  // 2. Shipping
  let shippingCost = 0;
  if (CART_STATE.isShippingRequired) {
    shippingCost = SHIPPING_FEE;
  }

  // 3. Final Total
  const finalTotal = subtotalAfterDiscount + shippingCost;
  
  // (NEW) Store final calculation values in a global object for checkout
  window.ORDER_TOTALS = {
      subtotal: subtotal,
      discountValue: discountValue,
      shippingCost: shippingCost,
      finalTotal: finalTotal,
      isShippingRequired: CART_STATE.isShippingRequired,
      promoCode: CART_STATE.promoCode
  };

  // --- Update Summary UI ---

  document.getElementById('itemCountDisplay').textContent = totalItems;
  document.getElementById('subTotal').textContent = formatPrice(subtotal);

  // Discount UI
  const discountRow = document.getElementById('discountRow');
  if (discountValue > 0) {
    discountRow.style.display = 'flex';
    document.getElementById('discountPercent').textContent = `${Math.round(discountRate * 100)}%`;
    document.getElementById('discountValue').textContent = `-${formatPrice(discountValue)}`;
  } else {
    discountRow.style.display = 'none';
  }

  // Shipping UI
  document.getElementById('shippingCost').textContent = CART_STATE.isShippingRequired ? formatPrice(shippingCost) : 'Free';

  // Final Total UI
  document.getElementById('finalTotal').textContent = formatPrice(finalTotal);

  // Promo message UI
  const promoMessageEl = document.getElementById('promoMessage');
  if (CART_STATE.promoCode && discountValue > 0) {
    promoMessageEl.textContent = `Promo code '${CART_STATE.promoCode.toUpperCase()}' applied.`;
    promoMessageEl.className = 'promo-message';
    promoMessageEl.style.display = 'block';
  } else if (CART_STATE.promoCode && discountValue === 0) {
     promoMessageEl.textContent = `Promo code '${CART_STATE.promoCode.toUpperCase()}' is invalid.`;
     promoMessageEl.className = 'promo-message error';
     promoMessageEl.style.display = 'block';
  } else {
    promoMessageEl.style.display = 'none';
  }
}

// 3. Cart Actions (Unchanged)

window.toggleShipping = function(isChecked) {
  CART_STATE.isShippingRequired = isChecked;
  saveCartState();
  render();
}

window.applyPromoCode = function() {
  const input = document.getElementById('promoInput').value.trim().toUpperCase();
  const messageEl = document.getElementById('promoMessage');

  if (input === '') {
    CART_STATE.promoCode = null;
    saveCartState();
    render();
    return;
  }

  if (PROMO_CODES[input]) {
    CART_STATE.promoCode = input;
    // Message will be handled by render() after state change
  } else {
    CART_STATE.promoCode = input; // Keep invalid code in state to show error message
  }

  saveCartState();
  render();
};

window.updateQty = function(id, change) {
  if (!CART_STATE.items[id]) return;
  CART_STATE.items[id] += change;
  if (CART_STATE.items[id] <= 0) {
    delete CART_STATE.items[id];
  }
  saveCartState();
  render();
};

window.removeItem = function(id) {
  delete CART_STATE.items[id];
  saveCartState();
  render();
};


// 4. Checkout Logic (NEW)

/**
 * Handles the checkout process: sends order details via EmailJS 
 * and then redirects the user.
 */
window.handleCheckout = async function() {
    if (Object.keys(CART_STATE.items).length === 0) {
        alert('Your cart is empty. Please add items before checking out.');
        return;
    }

    if (typeof emailjs === 'undefined') {
        alert('Email service is not yet initialized. Please wait a moment and try again.');
        return;
    }

    // --- Build Email Content ---
    const total = formatPrice(window.ORDER_TOTALS.finalTotal);
    const subtotal = formatPrice(window.ORDER_TOTALS.subtotal);
    const discount = formatPrice(window.ORDER_TOTALS.discountValue);
    const shipping = window.ORDER_TOTALS.isShippingRequired ? formatPrice(window.ORDER_TOTALS.shippingCost) : 'Free';
    const promo = window.ORDER_TOTALS.promoCode || 'N/A';
    
    const orderDetails = window.ORDER_ITEMS_DETAIL.map(item => {
        return `${item.name} - Qty: ${item.qty} - ${formatPrice(item.lineTotal)} (${formatPrice(item.price)} ea)`;
    }).join('\n');
    
    const messageContent = `
        --- NEW NASSALAB ORDER ---
        
        Order Details:
        ${orderDetails}
        
        --- Summary ---
        Subtotal: ${subtotal}
        Discount (${promo}): ${discount}
        Shipping: ${shipping}
        
        FINAL TOTAL: ${total}
    `;

    // The template must be configured in EmailJS to accept these fields.
    const templateParams = {
        name: "Nassalab Customer (Unspecified)", // Placeholder, as cart.html lacks a name input
        email: "no-email-provided@nassalab.com", // Placeholder
        total: total,
        message: messageContent,
        subject: `New Nassalab Order - Total ${total}`
    };

    try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        
        alert(`‚úÖ Order details ($${total}) successfully sent for processing! Redirecting to checkout...`);
        
        // Redirect as per the original function's intent
        window.location.href = 'checkout.html'; 
    } catch (err) {
        alert('‚ùå Failed to send order details. Please check your EmailJS setup.');
        console.error("EmailJS Error:", err);
    }
};


// Start
init();

</script>

</body>
</html>
